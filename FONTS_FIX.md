# Исправление проблемы с отображением кириллицы в PDF отчетах

## Проблема
В сгенерированных PDF отчетах вместо кириллических символов отображались квадратики (□□□), а эмодзи не поддерживались.

## Причина
Стандартные шрифты PDF (Helvetica, Times, Courier) не поддерживают кириллицу. Для корректного отображения необходимы шрифты с поддержкой Unicode.

## Решение

### 1. Установка шрифтов DejaVu Sans

Шрифты DejaVu Sans полностью поддерживают кириллицу и многие другие Unicode символы.

**Автоматическая установка:**
```bash
make install-fonts
```

**Ручная установка:**
```bash
./scripts/install_fonts.sh
```

**Альтернативно (вручную):**
```bash
mkdir -p fonts
cd fonts
curl -L -O https://github.com/dejavu-fonts/dejavu-fonts/releases/download/version_2_37/dejavu-fonts-ttf-2.37.tar.bz2
tar -xjf dejavu-fonts-ttf-2.37.tar.bz2
mv dejavu-fonts-ttf-2.37/ttf/*.ttf .
rm -rf dejavu-fonts-ttf-2.37 dejavu-fonts-ttf-2.37.tar.bz2
```

### 2. Изменения в коде

#### `bot/services/report_generator.py`

**Регистрация шрифтов:**
- Добавлена функция `_register_fonts()` которая ищет шрифты DejaVu в проекте
- Поддержка fallback на системные шрифты
- Приоритет локальным шрифтам из директории `fonts/`

**Использование шрифтов:**
- Все стили (заголовки, текст, таблицы) используют DejaVu вместо Helvetica
- Автоматическая проверка доступности зарегистрированных шрифтов

### 3. Структура файлов

```
istra-watch/
├── fonts/                          # Шрифты (не коммитится в git)
│   ├── DejaVuSans.ttf             # Основной шрифт
│   ├── DejaVuSans-Bold.ttf        # Жирный шрифт
│   └── ... (другие варианты)
├── bot/services/
│   └── report_generator.py        # Генератор отчетов
├── scripts/
│   ├── install_fonts.sh           # Скрипт установки шрифтов
│   └── generate_report.py         # CLI для генерации отчетов
└── .gitignore                     # fonts/ добавлена в игнор
```

### 4. Развертывание на сервере

При развертывании на сервере **обязательно** выполнить установку шрифтов:

```bash
cd /path/to/project
./scripts/install_fonts.sh
```

Или добавить в deployment скрипт:
```bash
# В deployment/deploy.sh или аналогичном
if [ ! -f "fonts/DejaVuSans.ttf" ]; then
    echo "Installing fonts..."
    ./scripts/install_fonts.sh
fi
```

### 5. Проверка

После установки шрифтов:

```bash
# Сгенерировать тестовый отчет
make report

# Или с конкретными датами
python scripts/generate_report.py 2025-10-01 2025-10-31
```

При успешной регистрации шрифтов в консоли появится:
```
✓ Registered fonts: /path/to/fonts/DejaVuSans.ttf
```

## Результат

✅ Кириллица отображается корректно  
✅ Все русские тексты читаемы  
✅ PDF выглядит профессионально  
✅ Поддержка на разных ОС (macOS, Linux, Windows)

## Примечания

### Эмодзи
Эмодзи не были добавлены в PDF, так как:
- Требуют специальных шрифтов (например, Noto Color Emoji)
- Увеличивают размер файла
- Не все PDF ридеры корректно их отображают

Вместо эмодзи используются текстовые символы и форматирование.

### Размер шрифтов
Шрифты DejaVu занимают ~10-15 MB в директории `fonts/`. Они не включены в git репозиторий и устанавливаются отдельно при развертывании.

### Альтернативные шрифты
Если DejaVu недоступен, можно использовать другие шрифты с поддержкой кириллицы:
- Arial Unicode MS
- PT Sans
- Roboto
- Open Sans

Для этого нужно обновить пути в функции `_register_fonts()`.

## Дополнительная информация

См. также:
- `REPORTS.md` - полная документация по отчетам
- `QUICKSTART.md` - быстрый старт проекта
- `Makefile` - доступные команды

