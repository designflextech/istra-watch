# Архитектура проекта "Бот отметок для сотрудников"

Краткое описание структуры и основных паттернов. Проект — Telegram-бот с мини-приложением на базе python-telegram-bot 22.5, база данных — PostgreSQL, миграции — собственная система up/down, фронтенд — Vanilla JavaScript.

## Слои и ответственность

- **Входной слой (Handlers — `bot/handlers/*`)**
  - Описывает реакцию бота на команды и сообщения.
  - Минимум бизнес-логики: формирует запросы и вызывает сервисы.
  - `start_handler.py` — обработка команды /start, определение роли пользователя
  - `upload_excel_handler.py` — обработка загрузки Excel файлов с сотрудниками

- **Сервисный слой (Services — `bot/services/*`)**
  - Инкапсулирует бизнес-логику и сценарии использования.
  - Работает с моделями данных и внешними API.
  - `user_service.py` — сервис работы с пользователями, обработка Excel файлов
  - `record_service.py` — сервис создания и получения записей о приходе/уходе
  - `yandex_maps.py` — интеграция с Яндекс.Картами для геокодирования
  - `s3_service.py` — загрузка фотографий в облачное хранилище
  - `image_processor.py` — обработка и оптимизация изображений
  - `report_generator.py` — генерация PDF отчетов о дисциплине

- **Доступ к данным (Models — `bot/models/*`)**
  - Описывает схемы таблиц и сущности (ORM-модели).
  - `user.py` — модель пользователя с полями для Telegram данных
  - `record.py` — модель записи о приходе/уходе с геолокацией и фото
  - `address.py` — модель адреса для кэширования геокодирования

- **API слой (API — `bot/api/*`)**
  - REST API endpoints для мини-приложения.
  - Аутентификация через Telegram WebApp данные.
  - `routes.py` — маршруты API для фронтенда
  - `middleware.py` — middleware для аутентификации и CORS

- **Представление (Keyboards, Frontend)**
  - `bot/keyboards/` — фабрики клавиатур для бота
  - `bot/keyboards/admin_keyboard.py` — клавиатуры для администраторов
  - `bot/keyboards/user_keyboard.py` — клавиатуры для обычных пользователей
  - `frontend/` — мини-приложение на HTML/CSS/JavaScript
  - `frontend/static/js/screens/admin/` — экраны администратора
  - `frontend/static/js/screens/worker/` — экраны работника

- **Конфигурация и инфраструктура**
  - `bot/config.py` — централизованная конфигурация приложения
  - `bot/utils/database.py` — подключение к PostgreSQL
  - `bot/utils/telegram_auth.py` — валидация Telegram WebApp данных
  - `bot/migrations/` — система миграций up/down
  - `main.py` — точка входа с aiohttp webhook сервером

## Основные потоки выполнения

### 1) Запуск
- `main.py` → инициализация aiohttp приложения
- Регистрация webhook для Telegram updates
- Запуск REST API сервера для мини-приложения
- Обслуживание статических файлов фронтенда

### 2) Команда /start
- `handlers/start_handler.py:start_command` отправляет приветствие
- Определяется роль пользователя (администратор/работник)
- Показывается соответствующая клавиатура
- Администраторам доступна кнопка "Загрузить сотрудников"

### 3) Загрузка сотрудников (админ)
- `handlers/upload_excel_handler.py` обрабатывает Excel файлы
- `UserService.process_excel_file()` парсит файл и создает пользователей
- Валидация формата: ФИО | Telegram хендлер
- Batch вставка в базу данных с обработкой ошибок

### 4) Мини-приложение (аутентификация)
- Фронтенд получает `initData` от Telegram WebApp
- `API.auth()` валидирует данные через `telegram_auth.py`
- Возвращается информация о пользователе и роли
- Инициализируется соответствующий интерфейс

### 5) Отметка о приходе/уходе (работник)
- `screens/worker/record-form.js` — форма создания записи
- Получение геолокации через браузер API
- `API.getAddress()` — геокодирование через Яндекс.Карты
- `API.createRecord()` — сохранение записи в БД
- `API.uploadPhoto()` — загрузка фотографии в S3

### 6) Просмотр сотрудников (админ)
- `screens/admin/employees-list.js` — список сотрудников за день
- `API.getEmployeesStatus()` — получение статуса всех сотрудников
- Фильтрация по дате (до 1 месяца назад)
- Переход к деталям конкретного сотрудника

### 7) Генерация отчетов (админ)
- `screens/admin/reports.js` — форма выбора периода
- `API.generateReport()` — запрос на генерацию PDF
- `ReportGenerator` создает отчет с аналитикой
- Отправка готового отчета в чат с ботом

## Мини-приложение (Frontend)

### Архитектура фронтенда
- **Модульная структура** — каждый экран в отдельном файле
- **Единая точка входа** — `app.js` координирует все модули
- **Утилиты** — общие функции (API, геолокация, камера, карты)
- **Адаптивный дизайн** — оптимизация для мобильных устройств

### Экраны администратора
- **Список сотрудников** — отображение статуса всех сотрудников за день
- **Детали сотрудника** — временная линия записей конкретного сотрудника
- **Карта** — визуализация местоположений всех сотрудников
- **Отчеты** — генерация PDF отчетов за выбранный период

### Экраны работника
- **Главный экран** — кнопки отметки, история записей, карта
- **Форма записи** — создание записи с геолокацией и фото
- **Модальные окна** — детали записей, камера

### Навигация
- **Нижнее меню** — переключение между разделами (админ)
- **Кнопки "Назад"** — возврат к предыдущим экранам
- **Кэширование** — оптимизация загрузки данных

## Система записей (Records)

### Модель записи
- **Поля модели:**
  - `id` — уникальный идентификатор
  - `user_id` — связь с пользователем (FK)
  - `record_type` — тип записи ("arrival" / "departure")
  - `timestamp` — время создания записи
  - `latitude`, `longitude` — координаты GPS
  - `address_id` — связь с адресом (FK)
  - `comment` — комментарий пользователя
  - `photo_url` — ссылка на фотографию в S3

### Логика отметок
- **Приход** — первая отметка за день, создает запись типа "arrival"
- **Уход** — вторая отметка за день, создает запись типа "departure"
- **Валидация** — проверка на дублирование записей
- **Статусы** — "На месте", "Не на месте", "Нет отметок"

### Геолокация и адреса
- **Автоматическое определение** — через браузер Geolocation API
- **Геокодирование** — Яндекс.Карты API для получения адреса
- **Кэширование адресов** — таблица `addresses` для оптимизации
- **Валидация координат** — проверка корректности GPS данных

## Система пользователей (Users)

### Модель пользователя
- **Поля модели:**
  - `id` — Telegram user ID
  - `username` — Telegram username
  - `name` — полное имя из Excel
  - `is_admin` — флаг администратора
  - `avatar_url` — ссылка на аватар
  - `created_at` — дата добавления

### Роли и права
- **Администратор** — доступ к загрузке сотрудников, просмотру отчетов
- **Работник** — возможность создавать записи о приходе/уходе
- **Аутентификация** — через Telegram WebApp initData

### Загрузка из Excel
- **Формат файла** — две колонки: ФИО | Telegram хендлер
- **Валидация** — проверка формата и существования пользователей
- **Batch операции** — массовая вставка с обработкой ошибок
- **Статистика** — отчет о количестве добавленных/обновленных записей

## Интеграции и внешние сервисы

### Яндекс.Карты API
- **Геокодирование** — преобразование координат в адреса
- **Кэширование** — сохранение результатов в БД
- **Обработка ошибок** — fallback на координаты при недоступности API

### S3-совместимое хранилище
- **Загрузка фото** — сохранение фотографий с отметок
- **Оптимизация** — сжатие и изменение размера изображений
- **Безопасность** — подписанные URL для доступа к файлам

### Telegram WebApp API
- **Аутентификация** — валидация initData
- **Геолокация** — получение координат через браузер
- **Камера** — доступ к камере устройства
- **UI компоненты** — нативные элементы интерфейса

## Миграции и схема БД

### Таблицы
- **`users`** — пользователи системы (сотрудники и админы)
- **`records`** — записи о приходе/уходе с геолокацией
- **`addresses`** — кэш геокодированных адресов
- **`migrations`** — отслеживание примененных миграций

### Система миграций
- **Формат up/down** — каждая миграция имеет методы применения и отката
- **Версионирование** — последовательная нумерация миграций
- **Отслеживание** — таблица `migrations` для контроля состояния
- **Автоматическое применение** — при запуске приложения

### Связи между таблицами
- **User (1) → Records (many)** — один пользователь может иметь множество записей
- **Address (1) → Records (many)** — один адрес может использоваться в множестве записей
- **Внешние ключи** — обеспечение целостности данных

## Паттерны и соглашения

### Архитектурные принципы
- **Разделение ответственности** — четкое разделение на слои
- **Dependency Injection** — внедрение зависимостей через конструкторы
- **Асинхронность** — использование async/await для всех I/O операций
- **Обработка ошибок** — централизованная обработка исключений

### Соглашения по коду
- **1 модель = 1 класс = 1 таблица** — простота и понятность
- **1 хендлер = 1 файл = 1 действие** — модульность
- **1 клавиатура = 1 файл** — переиспользование
- **Префиксы callback_data** — `admin:`, `user:`, `record:`

### Безопасность
- **Валидация входных данных** — проверка всех пользовательских данных
- **Аутентификация** — проверка Telegram WebApp данных
- **Секреты в .env** — конфиденциальные данные в переменных окружения
- **HTTPS** — обязательное использование для webhook

### Производительность
- **Кэширование** — адресов, пользовательских данных
- **Пагинация** — для больших списков записей
- **Оптимизация изображений** — сжатие фотографий
- **Асинхронные операции** — неблокирующие запросы к БД

## Дополнительные возможности

### Отчеты и аналитика
- **PDF генерация** — отчеты о дисциплине сотрудников
- **Статистика** — сводные показатели по периодам
- **Экспорт данных** — возможность выгрузки в Excel
- **Графики** — визуализация данных посещаемости

### Уведомления
- **Push уведомления** — через Telegram Bot API
- **Email отчеты** — еженедельные сводки для админов
- **Алерты** — уведомления о нарушениях дисциплины

### Расширяемость
- **Модульная архитектура** — легко добавлять новые функции
- **API endpoints** — возможность интеграции с внешними системами
- **Плагины** — система расширений для дополнительной функциональности
- **Конфигурация** — настройка через переменные окружения