services:
  app:
    build: .
    container_name: istra-geo-bot
    restart: unless-stopped
    expose:
      - "${PORT:-3001}"
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_ADMIN_IDS: ${TELEGRAM_ADMIN_IDS}
      ENVIRONMENT: ${ENVIRONMENT}
      DOMAIN: ${DOMAIN}
      STACK: ${STACK}
      
      WEBHOOK_URL: ${WEBHOOK_URL}
      WEBHOOK_PATH: ${WEBHOOK_PATH:-/webhook}
      WEBHOOK_PORT: ${WEBHOOK_PORT:-8443}
      
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_SCHEMA: ${DB_SCHEMA}
      
      YANDEX_MAPS_API_KEY: ${YANDEX_MAPS_API_KEY}
      
      MINI_APP_URL: ${MINI_APP_URL}
      
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL}
      S3_REGION: ${S3_REGION:-ru-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${STACK}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${STACK}.entrypoints=websecure"
      - "traefik.http.routers.${STACK}.tls.certresolver=le"
      - "traefik.http.services.${STACK}.loadbalancer.server.port=8443"
    networks:
      - proxy
    command: python main.py
    
networks:
  proxy:
    external: true
